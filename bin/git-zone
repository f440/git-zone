#!/bin/bash

set -e

usage() {
  echo "Usage: git zone [<ref-or-pr>] [-c|--create <new-branch-name>]"
  echo
  echo "Create a new worktree for a given branch, ref, PR number, or PR URL."
  echo "Mimics 'git switch' behavior."
  echo
  echo "Arguments:"
  echo "  ref-or-pr     Reference (branch, tag, commit), PR number, or PR URL."
  echo "                If omitted, creates a new branch from the current commit."
  echo
  echo "Options:"
  echo "  -c, --create <name>  Create a new branch named <name> before switching."
  echo "  -h, --help           Show this help message and exit."
}

# --- Argument Parsing ---
REF_OR_PR=""
NEW_BRANCH_NAME=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    -c|--create)
      if [[ -n "$NEW_BRANCH_NAME" ]]; then
        echo "Error: -c/--create option can only be specified once." >&2
        usage
        exit 1
      fi
      if [[ -z "$2" || "$2" == -* ]]; then
        echo "Error: -c/--create option requires a branch name." >&2
        usage
        exit 1
      fi
      NEW_BRANCH_NAME="$2"
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    -*)
      echo "Error: Unknown option: $1" >&2
      usage
      exit 1
      ;;
    *)
      if [[ -n "$REF_OR_PR" ]]; then
        echo "Error: Cannot specify more than one reference." >&2
        usage
        exit 1
      fi
      REF_OR_PR="$1"
      shift
      ;;
  esac
done

# --- Validation ---
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  echo "Error: Not inside a git repository."
  exit 1
fi

# If ref-or-pr is not provided:
# - If -c/--create was not provided, create a new branch from the current commit.
# - If -c/--create was provided, create that branch from the current commit.
if [[ -z "$REF_OR_PR" ]]; then
  REF_OR_PR="$(git rev-parse HEAD)"

  if [[ -z "$NEW_BRANCH_NAME" ]]; then
    SHORT_SHA="$(git rev-parse --short HEAD)"
    BASE_BRANCH_NAME="zone-$SHORT_SHA"
    NEW_BRANCH_NAME="$BASE_BRANCH_NAME"
    n=2

    WORKTREE_ROOT="$(git worktree list | awk 'NR==1{print $1}')"
    while git show-ref --verify --quiet "refs/heads/$NEW_BRANCH_NAME" || [[ -e "$WORKTREE_ROOT.$NEW_BRANCH_NAME" ]]; do
      NEW_BRANCH_NAME="${BASE_BRANCH_NAME}-$n"
      ((n++))
    done

    echo "No reference provided; creating new branch '$NEW_BRANCH_NAME' from current commit: $REF_OR_PR"
  else
    echo "No reference provided, using current commit: $REF_OR_PR"
  fi
fi

if [[ -z "$WORKTREE_ROOT" ]]; then
  WORKTREE_ROOT="$(git worktree list | awk 'NR==1{print $1}')"
fi

# Detect if input is a PR number or PR URL
is_pr() {
  [[ "$1" =~ ^[0-9]+$ ]] || [[ "$1" =~ github\.com/.+/pull/[0-9]+ ]]
}

run_zone_setup() {
  local setup_command
  setup_command="$(git config --get zone.setup 2>/dev/null || true)"

  if [[ -z "$setup_command" ]]; then
    return
  fi

  echo "Running git-configured zone.setup command..."
  if ! WORKTREE_ROOT="$WORKTREE_ROOT" bash -c "$setup_command"; then
    echo "Warning: zone.setup command failed. Continuing without setup." >&2
  fi
}

# --- Main Logic ---

cd "$WORKTREE_ROOT"

if is_pr "$REF_OR_PR"; then
  # --- PR Handling ---
  if ! command -v gh >/dev/null 2>&1; then
    echo "Error: GitHub CLI (gh) is required for PR checkout functionality."
    exit 1
  fi

  if [[ "$REF_OR_PR" =~ ^[0-9]+$ ]]; then
    PR_NUM="$REF_OR_PR"
  else
    PR_NUM="$(echo "$REF_OR_PR" | grep -o '/pull/[0-9]\+' | cut -d'/' -f3)"
  fi

  if [ -n "$NEW_BRANCH_NAME" ]; then
      BRANCH_NAME_FOR_DIR="$NEW_BRANCH_NAME"
  else
      BRANCH_NAME_FOR_DIR="pr-$PR_NUM"
  fi
  ZONE_DIR="$WORKTREE_ROOT.$BRANCH_NAME_FOR_DIR"

  echo "Setting up worktree for PR $PR_NUM in '$ZONE_DIR'..."

  git worktree add --detach "$ZONE_DIR"
  cd "$ZONE_DIR"

  echo "Checking out PR $REF_OR_PR..."
  if ! gh pr checkout "$REF_OR_PR"; then
    echo "Error: Failed to checkout PR $REF_OR_PR." >&2
    cd "$WORKTREE_ROOT"
    git worktree remove "$ZONE_DIR" 2>/dev/null || true
    exit 1
  fi

  # If -c was used, rename the branch created by 'gh'
  if [ -n "$NEW_BRANCH_NAME" ]; then
    CURRENT_BRANCH=$(git symbolic-ref --short HEAD)
    echo "Renaming branch '$CURRENT_BRANCH' to '$NEW_BRANCH_NAME'."
    git branch -m "$NEW_BRANCH_NAME"
  fi

  echo "Successfully checked out PR $PR_NUM."


else
  # --- Ref (branch, tag, commit) Handling ---
  if [ -n "$NEW_BRANCH_NAME" ]; then
    # Case: git zone <ref> -c <new-branch>
    BRANCH_NAME_FOR_DIR="$NEW_BRANCH_NAME"
    ZONE_DIR="$WORKTREE_ROOT.$BRANCH_NAME_FOR_DIR"
    echo "Creating new branch '$NEW_BRANCH_NAME' from '$REF_OR_PR' in '$ZONE_DIR'..."
    git worktree add -b "$NEW_BRANCH_NAME" "$ZONE_DIR" "$REF_OR_PR"
    cd "$ZONE_DIR"
  else
    # Case: git zone <ref>
    # If ref is an existing local branch, use it.
    if git show-ref --verify --quiet "refs/heads/$REF_OR_PR"; then
        BRANCH_NAME_FOR_DIR="$REF_OR_PR"
        ZONE_DIR="$WORKTREE_ROOT.$BRANCH_NAME_FOR_DIR"
        echo "Creating worktree for existing branch '$REF_OR_PR' in '$ZONE_DIR'..."
        git worktree add "$ZONE_DIR" "$REF_OR_PR"
        cd "$ZONE_DIR"
    else
        # If ref is not a local branch (e.g., remote branch, tag, commit), create detached worktree.
        # Sanitize ref for directory name
        BRANCH_NAME_FOR_DIR=$(echo "$REF_OR_PR" | tr '/' '-')
        ZONE_DIR="$WORKTREE_ROOT.$BRANCH_NAME_FOR_DIR"
        echo "Creating detached worktree for '$REF_OR_PR' in '$ZONE_DIR'..."
        git worktree add --detach "$ZONE_DIR" "$REF_OR_PR"
        cd "$ZONE_DIR"
        echo "Note: Worktree is in a detached HEAD state."
    fi
  fi
fi

run_zone_setup

echo "Created: $ZONE_DIR"
